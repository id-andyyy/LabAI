---
name: lab-report
description: Генерация финального документа (DOCX/PDF/MD) с изображениями
---

Пользователь хочет сгенерировать финальный документ отчёта. На этом этапе report.md уже должен быть готов (создан через /lab-draft и доработан через /lab-improve, /lab-research, /lab-conclusion).

## Что делать

### Этап 1. Проверка полноты

1. Прочитай `.claude/lab/config.json`. Если не найден — сообщи: «Сначала запусти `/lab-setup`.» и остановись.
2. Проверь наличие `report.md`. Если не найден — сообщи: «Сначала создай черновик отчёта через `/lab-draft`.» и остановись.
3. Прочитай `report.md` и проверь:
   - Есть ли раздел дополнительного исследования (если `config.preferences.needs_research` = true) — предупредить, если нет (но не блокировать).
   - Есть ли итоговый вывод — предупредить, если нет (но не блокировать).
4. Спроси пользователя: продолжить генерацию или сначала доработать отчёт?

### Этап 2. Работа с изображениями

1. Проверь наличие папки `images/` в корне проекта.
2. Если папка существует и содержит файлы:
   a. Прочитай каждый файл изображения через Read tool (vision).
   b. Проанализируй содержимое каждого изображения.
   c. Сопоставь содержимое изображений с подписями рисунков в report.md.
   d. Создай `.claude/lab/image_map.json` — маппинг номера рисунка на файл:
      ```json
      {
        "1": "images/screenshot1.png",
        "2": "images/network_config.jpg"
      }
      ```
   e. Если автоматическое сопоставление не удалось для некоторых изображений — покажи пользователю список нераспознанных файлов и подписей, спроси о соответствии.
3. Если папка `images/` пуста или не существует — предупредить (плейсхолдеры останутся в документе).

### Этап 3. Генерация документа

Определи формат из `config.preferences.report_format` и имя файла из `config.preferences.output_filename` (по умолчанию `report`).

**ВАЖНО:** report.md — это черновик. Этот этап НЕ меняет содержание report.md. Генерация итогового файла — это только форматирование: подстановка изображений, отступы, стили, титульный лист. Если пользователь предоставил пример готовой лабораторной (DOCX) — стили берутся из него.

**Формат MD:**
- Скопировать report.md в `{output_filename}.md` (если имя отличается от `report`; иначе — в `output.md`, чтобы не перезаписать черновик).
- Заменить плейсхолдеры `[ВСТАВИТЬ РИСУНОК N ЗДЕСЬ]` на `![Рисунок N. Описание](images/файл.png)` (используя image_map.json).

**Формат DOCX:**
1. Проверь наличие venv: `.claude/lab/venv/bin/python --version` (или `Scripts/python.exe` на Windows).
2. Если venv есть — запусти генератор:
   ```
   .claude/lab/venv/bin/python .claude/lab/scripts/generate_docx.py \
     --config .claude/lab/config.json \
     --report report.md \
     --output {output_filename}.docx \
     --images images/ \
     --image-map .claude/lab/image_map.json
   ```
   Если есть пример-шаблон (`config.example.has_example` = true и `config.example.example_path` не null):
   ```
     --template .claude/lab/templates/example.docx
   ```
3. Если venv нет — сообщи, что DOCX-генерация невозможна без Python. Предложи формат MD.

**Формат PDF:**
1. Сначала сгенерируй DOCX (как описано выше).
2. Проверь наличие LibreOffice: `libreoffice --version`.
3. Если LibreOffice есть — конвертируй: `libreoffice --headless --convert-to pdf {output_filename}.docx`.
4. Если LibreOffice нет — сообщи пользователю, что PDF-конвертация невозможна. Предложи открыть DOCX и сохранить как PDF вручную.

### Этап 4. Подтверждение

Сообщи пользователю:
- Путь к сгенерированному файлу (report.docx / report.pdf / report.md).
- Количество вставленных изображений (если были).
- Количество оставшихся плейсхолдеров (если изображения не найдены).
- Рекомендацию проверить документ перед сдачей.

## Дополнительный контекст от пользователя

$ARGUMENTS
